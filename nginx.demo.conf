worker_processes auto; # Auto-detect CPU cores for optimal performance
pid /tmp/nginx.pid; # Process ID file location
error_log /dev/stderr warn; # Log errors to docker container at 'warn' level and above

events {
    worker_connections 4096; # Max simultaneous connections per worker (tune based on traffic)
}

http {
    include /etc/nginx/mime.types; # Load MIME type mappings (critical for serving JS/CSS correctly)
    default_type application/octet-stream; # Fallback MIME type for unknown files

    # Redirect all cache directories to /tmp (writable by unprivileged nginx user)
    client_body_temp_path /tmp/client_temp;
    proxy_temp_path /tmp/proxy_temp;
    fastcgi_temp_path /tmp/fastcgi_temp;
    uwsgi_temp_path /tmp/uwsgi_temp;
    scgi_temp_path /tmp/scgi_temp;

    server_tokens off; # Hide nginx version in headers (prevents version-specific attacks)

    # Performance optimizations for static file serving
    sendfile on; # Efficient file transfer using kernel space (bypass user space)
    tcp_nopush on; # Send headers in one packet with sendfile (reduces network overhead)
    tcp_nodelay on; # Disable Nagle's algorithm for low-latency responses
    keepalive_timeout 65; # Keep connections alive for 65s to reuse TCP connections

    # Gzip compression for text-based assets (reduces bandwidth by 60-80%)
    gzip on; # Enable gzip compression
    gzip_vary on; # Add Vary: Accept-Encoding header for proper caching
    gzip_proxied any; # Compress responses for proxied requests
    gzip_comp_level 6; # Compression level 1-9 (6 is optimal balance of speed/size)
    gzip_buffers 16 8k; # Memory buffers for compression (16 buffers of 8KB each)
    gzip_http_version 1.1; # Only compress HTTP/1.1+ requests
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; # Compress these MIME types


    server {
        listen 443 ssl proxy_protocol; # expects layer 4 proxy-protocol v2 headers
        server_name demo.fiscalismia.com;

        # TLS certificates copied to correct location via Dockerfile
        ssl_certificate     /etc/nginx/certs/fullchain.pem;
        ssl_certificate_key /etc/nginx/certs/privkey.pem;
        ssl_protocols       TLSv1.3;

        # Trust ingress from HAProxy /w added PROXY protocol v2 data
        set_real_ip_from 172.24.1.3;  # HAProxy internal IP production network
        set_real_ip_from 172.20.1.3;  # HAProxy internal IP demo network

        # Now $remote_addr contains the real client IP extracted from proxy protocol v2 header
        real_ip_header proxy_protocol;

        # For logging the real client IP
        access_log /dev/stdout combined;

        root /usr/share/nginx/html; # Document root directory
        index index.html; # Default file to serve

        # Security headers applied to ALL responses
        add_header X-Content-Type-Options "nosniff" always; # Prevent MIME type sniffing attacks
        add_header X-Frame-Options "DENY" always; # Prevent clickjacking (disallow iframes)
        add_header X-XSS-Protection "1; mode=block" always; # Enable browser XSS filter
        add_header Referrer-Policy "strict-origin-when-cross-origin" always; # Control referrer info sent to other sites
        # CSP: restricts which resources can be loaded (prevents XSS/injection attacks)
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://your-api-domain.com;" always;

        # SPA routing: serve index.html for all non-file requests
        location / {
            try_files $uri $uri/ /index.html; # Check file → directory → fallback to index.html
            add_header Cache-Control "no-cache, must-revalidate" always; # Force revalidation of index.html so updates are retrieved immediately
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_protocol_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Aggressive caching for static assets (vite adds content hash to filenames)
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf|eot)$ {
            access_log off; # Don't log static asset requests (reduces I/O)
            add_header Cache-Control "public, max-age=31536000, immutable" always; # Cache for 1 year (files are immutable due to hash)
        }

        # Block access to hidden files (.git, .env, etc.)
        location ~ /\. {
            deny all; # Return 403 Forbidden
        }

        # Block access to config files that shouldn't be public
        location ~* (package\.json|package-lock\.json|tsconfig\.json|vite\.config\.ts)$ {
            deny all; # Return 403 Forbidden
        }
    }
}